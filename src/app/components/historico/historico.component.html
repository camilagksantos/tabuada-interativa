<div class="historico-container">
    <!-- Header com botÃµes -->
    <div class="historico-header">
        <button class="btn-voltar" (click)="voltarHome()">
            â† Voltar
        </button>
        <h1>ğŸ“Š HistÃ³rico de Partidas</h1>
        <button class="btn-limpar" (click)="limparTudo()" *ngIf="partidas.length > 0">
            ğŸ—‘ï¸ Limpar Tudo
        </button>
    </div>

    <!-- Mensagem quando vazio -->
    <div class="historico-content" *ngIf="partidas.length === 0">
        <div class="vazio">
            <p>ğŸ“­ Nenhuma partida registrada ainda!</p>
            <p>Jogue para comeÃ§ar seu histÃ³rico.</p>
        </div>
    </div>

    <!-- ConteÃºdo principal quando hÃ¡ partidas -->
    <div class="historico-content" *ngIf="partidas.length > 0">

        <!-- Filtros -->
        <div class="filtros-container">
            <div class="filtro">
                <label>ğŸ“… PerÃ­odo:</label>
                <select [(ngModel)]="periodoSelecionado" (change)="onFiltroChange()">
                    <option [value]="7">Ãšltimos 7 dias</option>
                    <option [value]="30">Ãšltimos 30 dias</option>
                    <option [value]="90">Ãšltimos 90 dias</option>
                    <option [value]="0">Todos os perÃ­odos</option>
                </select>
            </div>

            <div class="filtro">
                <label>ğŸ‘¤ Jogador:</label>
                <select [(ngModel)]="jogadorSelecionado" (change)="onFiltroChange()">
                    <option value="">Todos jogadores</option>
                    <option *ngFor="let jogador of listaJogadores" [value]="jogador">
                        {{ jogador | titlecase }}
                    </option>
                </select>
            </div>
        </div>

        <!-- Abas de navegaÃ§Ã£o -->
        <div class="tabs-container">
            <button class="tab-btn" [class.active]="abaAtiva === 'resumo'" (click)="mudarAba('resumo')">
                ğŸ“Š Resumo
            </button>
            <button class="tab-btn" [class.active]="abaAtiva === 'partidas'" (click)="mudarAba('partidas')">
                ğŸ“œ Partidas
            </button>
            <button class="tab-btn" [class.active]="abaAtiva === 'stats'" (click)="mudarAba('stats')">
                ğŸ† EstatÃ­sticas
            </button>
        </div>

        <!-- ========== ABA RESUMO ========== -->
        <div class="tab-content" *ngIf="abaAtiva === 'resumo'">

            <!-- Cards de estatÃ­sticas gerais -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icone">ğŸ®</div>
                    <div class="stat-valor">{{ estatisticasGerais.totalPartidas }}</div>
                    <div class="stat-label">Partidas</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icone">â­</div>
                    <div class="stat-valor" [style.color]="getCorTaxaAcerto(estatisticasGerais.taxaAcertoMedia)">
                        {{ estatisticasGerais.taxaAcertoMedia }}%
                    </div>
                    <div class="stat-label">Taxa de Acerto</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icone">â±ï¸</div>
                    <div class="stat-valor">{{ estatisticasGerais.tempoMedioPorQuestao }}s</div>
                    <div class="stat-label">Tempo MÃ©dio/QuestÃ£o</div>
                </div>
            </div>

            <!-- Jogadores cadastrados -->
            <div class="secao-card" *ngIf="listaJogadores.length > 0">
                <h3>ğŸ‘¥ Jogadores Cadastrados</h3>
                <div class="jogadores-grid">
                    <div class="jogador-badge" *ngFor="let jogador of listaJogadores"
                        (click)="jogadorSelecionado = jogador; onFiltroChange(); mudarAba('stats')">
                        <div class="jogador-nome">{{ jogador | titlecase }}</div>
                        <div class="jogador-partidas">
                            {{ historicoService.getPartidasPorJogador(jogador).length }} partidas
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabuadas mais praticadas -->
            <div class="secao-card" *ngIf="estatisticasGerais.tabuadasMaisPraticadas.length > 0">
                <h3>ğŸ”¢ Tabuadas Mais Praticadas</h3>
                <div class="ranking-lista">
                    <div class="ranking-item"
                        *ngFor="let item of estatisticasGerais.tabuadasMaisPraticadas; let i = index">
                        <span class="ranking-posicao">{{ i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰' }}</span>
                        <span class="ranking-texto">Tabuada do {{ item.tabuada }}</span>
                        <span class="ranking-valor">{{ item.vezes }}x</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- ========== ABA PARTIDAS ========== -->
        <div class="tab-content" *ngIf="abaAtiva === 'partidas'">

            <!-- Agrupamento por jogador -->
            <div class="jogador-grupo" *ngFor="let grupo of getJogadoresAgrupados()">
                <div class="jogador-grupo-header">
                    <h3>ğŸ‘¤ {{ grupo.nome }} <span class="badge">{{ grupo.partidas.length }} partidas</span></h3>
                </div>

                <!-- Lista de partidas do jogador -->
                <div class="partida-card" *ngFor="let partida of grupo.partidas">
                    <div class="partida-header">
                        <div class="partida-data">
                            ğŸ“… {{ formatarDataRelativa(partida.data) }} - {{ formatarData(partida.data).split(' ')[1] }}
                        </div>
                        <button class="btn-deletar" (click)="deletarPartida(partida.id)">
                            âŒ
                        </button>
                    </div>

                    <div class="partida-resumo">
                        <div class="resumo-item">
                            <span class="resumo-label">ğŸ“š Tabuadas:</span>
                            <span class="resumo-valor">{{ partida.tabuadas.join(', ') }}</span>
                        </div>
                        <div class="resumo-item">
                            <span class="resumo-label">ğŸ² Modo:</span>
                            <span class="resumo-valor">{{ partida.modoAleatorio ? 'AleatÃ³rio' : 'Sequencial' }}</span>
                        </div>
                        <div class="resumo-item">
                            <span class="resumo-label">â±ï¸ Tempo:</span>
                            <span class="resumo-valor">{{ formatarTempo(partida.tempoTotalSegundos) }}</span>
                        </div>
                    </div>

                    <div class="partida-resultado">
                        <div class="resultado-badge acertos">
                            <span class="resultado-numero">{{ partida.corretos }}</span>
                            <span class="resultado-texto">Corretos â­</span>
                        </div>
                        <div class="resultado-badge erros">
                            <span class="resultado-numero">{{ partida.incorretos }}</span>
                            <span class="resultado-texto">Incorretos âŒ</span>
                        </div>
                        <div class="resultado-badge percentual">
                            <span class="resultado-numero"
                                [style.color]="getCorTaxaAcerto((partida.corretos / (partida.corretos + partida.incorretos) * 100))">
                                {{ (partida.corretos / (partida.corretos + partida.incorretos) * 100).toFixed(0) }}%
                            </span>
                            <span class="resultado-texto">Aproveitamento</span>
                        </div>
                    </div>

                    <!-- Detalhes das questÃµes -->
                    <details class="questoes-detalhes">
                        <summary>Ver questÃµes detalhadas</summary>
                        <div class="questoes-lista">
                            <div class="questao-item" *ngFor="let questao of partida.questoes; let i = index"
                                [class.correta]="questao.correta" [class.incorreta]="!questao.correta">
                                <span class="questao-numero">{{ i + 1 }}</span>
                                <span class="questao-pergunta">{{ questao.pergunta }} = ?</span>
                                <span class="questao-resposta">{{ questao.respostaUsuario }}</span>
                                <span class="questao-tempo">â±ï¸ {{ questao.tempoSegundos }}s</span>
                                <span class="questao-status">{{ questao.correta ? 'âœ“' : 'âœ—' }}</span>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

        </div>

        <!-- ========== ABA ESTATÃSTICAS ========== -->
        <div class="tab-content" *ngIf="abaAtiva === 'stats'">

            <!-- Mensagem quando nenhum jogador selecionado -->
            <div class="aviso-card" *ngIf="!jogadorSelecionado">
                <p>ğŸ‘† Selecione um jogador no filtro acima para ver estatÃ­sticas detalhadas!</p>
            </div>

            <!-- EstatÃ­sticas do jogador selecionado -->
            <div *ngIf="jogadorSelecionado && estatisticasJogador">

                <!-- CabeÃ§alho com nome do jogador -->
                <div class="stats-header">
                    <h2>ğŸ“Š AnÃ¡lise: {{ jogadorSelecionado | titlecase }}</h2>
                </div>

                <!-- Cards de desempenho -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icone">ğŸ®</div>
                        <div class="stat-valor">{{ estatisticasJogador.totalPartidas }}</div>
                        <div class="stat-label">Total de Partidas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icone">â­</div>
                        <div class="stat-valor" [style.color]="getCorTaxaAcerto(estatisticasJogador.taxaAcerto)">
                            {{ estatisticasJogador.taxaAcerto }}%
                        </div>
                        <div class="stat-label">Taxa de Acerto</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icone">ğŸ†</div>
                        <div class="stat-valor" [style.color]="getCorTaxaAcerto(estatisticasJogador.melhorResultado)">
                            {{ estatisticasJogador.melhorResultado }}%
                        </div>
                        <div class="stat-label">Melhor Resultado</div>
                    </div>
                </div>

                <!-- Desempenho por tabuada -->
                <div class="secao-card" *ngIf="estatisticasJogador.tabuadasPraticadas.length > 0">
                    <h3>ğŸ”¢ Desempenho por Tabuada</h3>
                    <div class="tabuadas-lista">
                        <div class="tabuada-item" *ngFor="let tab of estatisticasJogador.tabuadasPraticadas">
                            <div class="tabuada-numero">{{ tab.tabuada }}x</div>
                            <div class="tabuada-barra-container">
                                <div class="tabuada-barra" [style.width.%]="tab.taxaAcerto"
                                    [style.background-color]="getCorTaxaAcerto(tab.taxaAcerto)">
                                </div>
                            </div>
                            <div class="tabuada-info">
                                <span class="tabuada-taxa" [style.color]="getCorTaxaAcerto(tab.taxaAcerto)">
                                    {{ tab.taxaAcerto }}%
                                </span>
                                <span class="tabuada-vezes">({{ tab.vezes }} questÃµes)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QuestÃµes mais difÃ­ceis -->
                <div class="secao-card" *ngIf="estatisticasJogador.questoesDificeis.length > 0">
                    <h3>âš ï¸ QuestÃµes que Precisam de AtenÃ§Ã£o</h3>
                    <div class="questoes-dificeis-lista">
                        <div class="questao-dificil" *ngFor="let questao of estatisticasJogador.questoesDificeis">
                            <span class="questao-dificil-pergunta">{{ questao.pergunta }}</span>
                            <span class="questao-dificil-taxa" [style.color]="getCorTaxaAcerto(questao.taxaAcerto)">
                                {{ questao.taxaAcerto }}% acerto
                            </span>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>
</div>